SELECT a.user_id, a.created_at, a.phone_number, b.user_name, a.coupon_code, q.language, screen_status AS latest_screen_status, (CASE WHEN c.fl_validated = 0 THEN 'A: Coupon_needs_to_be_verifed' WHEN ac.fl_consent = 0 OR ac.user_id IS NULL THEN 'B: bureau_consent_not_given' WHEN i1.user_id IS NULL THEN 'C: OTP_Not_Triggered' WHEN i1.fl_verified = 0 THEN 'D: otp_triggered_not_verifed' WHEN b.pannumber IS NULL THEN 'E: Needs To enter PAN' WHEN q.user_id IS NULL THEN 'F: Needs to complete questionnaire' WHEN ad.user_id IS NULL THEN 'G: Needs to complete address' WHEN screen_status = 6 THEN 'H: Needs to open webpage again for decision' WHEN e.user_id IS NOT NULL AND screen_status = 8 THEN 'I: Rejected' WHEN screen_status = 9 OR g.user_id IS NULL THEN 'J: seen_offer_no_action_taken' WHEN g.products_redirected IS NOT NULL THEN 'K: user_redirected_partner_screen' WHEN g.products_viewed IS NOT NULL THEN 'L: not_redirected_to_partner_screen' END) AS status FROM (SELECT User_id, phone_number, coupon_code, created_at, final_partner FROM reporting_db.marketing_master WHERE DATE(created_at) >= "2024-04-01") a LEFT JOIN user b ON a.user_id = b.id LEFT JOIN (SELECT user_id, fl_validated FROM user_promotional_coupon_validation_logs WHERE id IN (SELECT MAX(id) FROM user_promotional_coupon_validation_logs GROUP BY user_id)) c ON a.user_id = c.user_id LEFT JOIN (SELECT user_id, consent_type, fl_consent FROM user_app_consent_master WHERE id IN (SELECT MAX(id) FROM user_app_consent_master WHERE consent_type = 'bureau' GROUP BY user_id)) ac ON a.user_id = ac.user_id LEFT JOIN (SELECT * FROM otp_api_partner_config WHERE id IN (SELECT MAX(id) FROM otp_api_partner_config WHERE event = 'signup' GROUP BY user_id)) i1 ON a.user_id = i1.user_id LEFT JOIN (SELECT user_id, CASE WHEN JSON_EXTRACT(questions_response, '$[0].question_response[0].options[0].field_text') IS NOT NULL THEN JSON_UNQUOTE(JSON_EXTRACT(questions_response, '$[0].question_response[0].options[0].field_text')) ELSE JSON_UNQUOTE(JSON_EXTRACT(questions_response, '$[0].options[0].option_text')) END AS language FROM questionnaire_response WHERE id IN (SELECT MAX(id) FROM questionnaire_response GROUP BY user_id)) q ON a.user_id = q.user_id LEFT JOIN (SELECT user_id FROM user_address WHERE id IN (SELECT MAX(id) FROM user_address GROUP BY user_id)) ad ON a.user_id = ad.user_id LEFT JOIN (SELECT user_id, screen_status FROM userstatus_v2 WHERE id IN (SELECT MAX(id) FROM userstatus_v2 GROUP BY user_id)) e ON a.user_id = e.user_id LEFT JOIN (SELECT user_id, GROUP_CONCAT(CASE WHEN activity = 'apply' THEN b.sub_offer_name ELSE NULL END ORDER BY b.sub_offer_name SEPARATOR ',') AS products_redirected, GROUP_CONCAT(CASE WHEN activity <> 'apply' THEN b.sub_offer_name ELSE NULL END ORDER BY b.sub_offer_name SEPARATOR ',') AS products_viewed FROM (SELECT * FROM user_offer_activity_details) a LEFT JOIN (SELECT * FROM asp_playground.sub_offer_name) b ON a.sub_offer_id = b.sub_offer_id GROUP BY 1) g ON a.user_id = g.user_id where g.products_viewed is null and g.products_redirected is null and screen_status <> 9; 
